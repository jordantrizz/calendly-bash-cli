#!/bin/bash
# calendly - A bash CLI for interacting with the Calendly API
# Version: 0.2.2

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source library files (logging first for debug functions)
source "$SCRIPT_DIR/lib/logging.sh"
source "$SCRIPT_DIR/lib/api.sh"
source "$SCRIPT_DIR/lib/auth.sh"
source "$SCRIPT_DIR/lib/events.sh"
source "$SCRIPT_DIR/lib/webhooks.sh"

# Version
VERSION="0.2.2"

# Check for required dependencies
check_dependencies() {
    local missing=()
    
    if ! command -v curl &>/dev/null; then
        missing+=("curl")
    fi
    
    if ! command -v jq &>/dev/null; then
        missing+=("jq")
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Error: Missing required dependencies: ${missing[*]}" >&2
        echo "Please install them before using this CLI." >&2
        exit 1
    fi
}

# Display help message
show_help() {
    cat <<EOF
calendly - Calendly CLI v${VERSION}

A bash script for interacting with the Calendly API.

USAGE:
    calendly [options] <command> [arguments]

OPTIONS:
    -d              Enable debug output
    -dd             Enable verbose debug output (masks tokens)
    -ddd            Enable curl command debug (shows curl commands and raw responses)
    -h, --help      Show this help message
    -v, --version   Show version information

COMMANDS:
    auth test       Test authentication by verifying API key
    auth user       Show current user information
    events list     List scheduled events
    events get      Get details of a specific event
    events invitees List invitees for an event
    webhooks list   List webhook subscriptions
    webhooks create Create a new webhook subscription
    webhooks delete Delete a webhook subscription
    webhooks events List available webhook event types
    version         Show version information
    help            Show this help message

AUTHENTICATION:
    Set your Calendly API key using one of these methods:
    1. Environment variable: export CALENDLY_API_KEY="your_api_key"
    2. Config file: Add CALENDLY_API_KEY=your_api_key to ~/.calendly

    Generate a Personal Access Token at:
    https://calendly.com/integrations/api_webhooks

CONFIG FILE (~/.calendly):
    CALENDLY_API_KEY=your_api_key
    CALENDLY_API_BASE=https://api.calendly.com  (optional)
    CALENDLY_DEBUG=0                             (optional: 0, 1, 2, or 3)

EXAMPLES:
    calendly auth test       # Verify your API key works
    calendly auth user       # Display your user information
    calendly events list     # List your scheduled events
    calendly events get UUID # Get event details
    calendly webhooks list   # List webhook subscriptions
    calendly webhooks create --url https://example.com/hook --events invitee.created
    calendly -d auth test    # Test with debug output

EOF
}

# Show version
show_version() {
    echo "calendly version ${VERSION}"
}

# Auth commands
cmd_auth() {
    local subcommand="$1"
    shift || true
    
    case "$subcommand" in
        test)
            echo "Testing authentication..."
            if verify_auth; then
                echo "✓ Authentication successful!"
                local user_uri
                user_uri=$(get_current_user_uri)
                echo "  User URI: $user_uri"
            else
                echo "✗ Authentication failed"
                exit 1
            fi
            ;;
        user)
            local response
            response=$(calendly_api GET "/users/me")
            echo "$response" | jq '.resource'
            ;;
        *)
            echo "Unknown auth command: $subcommand" >&2
            echo "Available commands: test, user" >&2
            exit 1
            ;;
    esac
}

# Main entry point
main() {
    # Check dependencies first
    check_dependencies
    
    # Parse global options first (before command)
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -ddd)
                set_debug_level 3
                debug "Curl command debug mode enabled (shows curl commands and raw responses)"
                shift
                ;;
            -dd)
                set_debug_level 2
                debug "Verbose debug mode enabled (tokens will be masked)"
                shift
                ;;
            -d)
                set_debug_level 1
                debug "Debug mode enabled"
                shift
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -*)
                echo "Unknown option: $1" >&2
                echo "Run 'calendly help' for usage information." >&2
                exit 1
                ;;
            *)
                break
                ;;
        esac
    done
    
    # Parse command
    local command="${1:-help}"
    shift || true
    
    # Handle version and help without auth
    case "$command" in
        version)
            show_version
            exit 0
            ;;
        help)
            show_help
            exit 0
            ;;
    esac
    
    # Load API key for commands that need it
    load_api_key || exit 1
    
    # Route to appropriate command handler
    case "$command" in
        auth)
            cmd_auth "$@"
            ;;
        events)
            cmd_events "$@"
            ;;
        webhooks)
            cmd_webhooks "$@"
            ;;
        *)
            echo "Unknown command: $command" >&2
            echo "Run 'calendly help' for usage information." >&2
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
